<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ROSS: core/network-mpi.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ROSS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">core/network-mpi.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="network-mpi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;<a class="code" href="ross_8h.html">ross.h</a>&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a><a class="code" href="network-mpi_8c.html#a18cfc5d78424c8e766f64ca4fb150fd8">00004</a> <span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="network-mpi_8c.html#a18cfc5d78424c8e766f64ca4fb150fd8">id_tmp</a>;
<a name="l00005"></a>00005 
<a name="l00006"></a><a class="code" href="structact__q.html">00006</a> <span class="keyword">struct </span><a class="code" href="structact__q.html">act_q</a>
<a name="l00007"></a>00007 {
<a name="l00008"></a><a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">00008</a>   <span class="keyword">const</span> <span class="keywordtype">char</span>     *<a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">name</a>;
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">00010</a>   <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a>      **<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>;
<a name="l00011"></a><a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">00011</a>   MPI_Request    *<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>;
<a name="l00012"></a><a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">00012</a>   <span class="keywordtype">int</span>            *<a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">idx_list</a>;
<a name="l00013"></a><a class="code" href="structact__q.html#a1a280efeb12c61fba82288f089b271f3">00013</a>   MPI_Status     *<a class="code" href="structact__q.html#a1a280efeb12c61fba82288f089b271f3">status_list</a>;
<a name="l00014"></a>00014 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span>  <span class="keywordtype">char</span>          **buffers;
<a name="l00016"></a>00016 <span class="preprocessor">#endif</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">00018</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>;
<a name="l00019"></a>00019 };
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="network-mpi_8c.html#a21f58374b1b9d28d08d7f4eabddbba82">00021</a> <span class="preprocessor">#define EVENT_TAG 1</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#define EVENT_SIZE(e) TW_MEMORY_BUFFER_SIZE</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00026"></a><a class="code" href="network-mpi_8c.html#a5a389c807591f69a3806763bc9c089fa">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define EVENT_SIZE(e) g_tw_event_msg_sz</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">00029</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structact__q.html">act_q</a> <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>;
<a name="l00030"></a><a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">00030</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structact__q.html">act_q</a> <a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>;
<a name="l00031"></a><a class="code" href="network-mpi_8c.html#aa5267efaec2ae6f7ecae78419aa0685e">00031</a> <span class="keyword">static</span> <a class="code" href="structtw__eventq.html">tw_eventq</a> <a class="code" href="network-mpi_8c.html#aa5267efaec2ae6f7ecae78419aa0685e">outq</a>;
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">00033</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a> = 50000;
<a name="l00034"></a><a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">00034</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">send_buffer</a> = 50000;
<a name="l00035"></a><a class="code" href="network-mpi_8c.html#ab8411355a7d80016be6edcce3437b978">00035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="network-mpi_8c.html#ab8411355a7d80016be6edcce3437b978">world_size</a> = 1;
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="network-mpi_8c.html#ac65f4401b7c7a792dc3fdbcae30a2c1c">00037</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structtw__optdef.html">tw_optdef</a> <a class="code" href="network-mpi_8c.html#ac65f4401b7c7a792dc3fdbcae30a2c1c">mpi_opts</a>[] = {
<a name="l00038"></a>00038   <a class="code" href="tw-opts_8h.html#a0e45b7a88a51dca3fe99d31aae9636c4">TWOPT_GROUP</a>(<span class="stringliteral">&quot;ROSS MPI Kernel&quot;</span>),
<a name="l00039"></a>00039   <a class="code" href="tw-opts_8h.html#a0d00417e3bef0d001f256f846c72838d">TWOPT_UINT</a>(
<a name="l00040"></a>00040              <span class="stringliteral">&quot;read-buffer&quot;</span>,
<a name="l00041"></a>00041              <a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a>,
<a name="l00042"></a>00042              <span class="stringliteral">&quot;network read buffer size in # of events&quot;</span>),
<a name="l00043"></a>00043   <a class="code" href="tw-opts_8h.html#a0d00417e3bef0d001f256f846c72838d">TWOPT_UINT</a>(
<a name="l00044"></a>00044              <span class="stringliteral">&quot;send-buffer&quot;</span>,
<a name="l00045"></a>00045              <a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">send_buffer</a>,
<a name="l00046"></a>00046              <span class="stringliteral">&quot;network send buffer size in # of events&quot;</span>),
<a name="l00047"></a>00047   <a class="code" href="tw-opts_8h.html#a38209b0e7568d41f5448ae5f884290a4">TWOPT_END</a>()
<a name="l00048"></a>00048 };
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">const</span> <a class="code" href="structtw__optdef.html">tw_optdef</a> *
<a name="l00051"></a><a class="code" href="ross-network_8h.html#a3db61a41bb6a85964e22e5488038b02e">00051</a> <a class="code" href="network-mpi_8c.html#a3db61a41bb6a85964e22e5488038b02e">tw_net_init</a>(<span class="keywordtype">int</span> *argc, <span class="keywordtype">char</span> ***argv)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053   <span class="keywordtype">int</span> my_rank;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="keywordflow">if</span> (MPI_Init(argc, argv) != MPI_SUCCESS)
<a name="l00056"></a>00056     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;MPI_Init failed.&quot;</span>);
<a name="l00057"></a>00057   <span class="keywordflow">if</span> (MPI_Comm_rank(MPI_COMM_WORLD, &amp;my_rank) != MPI_SUCCESS)
<a name="l00058"></a>00058     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Cannot get MPI_Comm_rank(MPI_COMM_WORLD)&quot;</span>);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060   <a class="code" href="ross-extern_8h.html#a5c6d576b06ba7fb5b28bc93c0b51f764">g_tw_masternode</a> = 0;
<a name="l00061"></a>00061   <a class="code" href="ross-extern_8h.html#aced8e9c1a7ab2577b8aed2f9c11468da">g_tw_mynode</a> = my_rank;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063   <span class="keywordflow">return</span> <a class="code" href="network-mpi_8c.html#ac65f4401b7c7a792dc3fdbcae30a2c1c">mpi_opts</a>;
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00067"></a><a class="code" href="network-mpi_8c.html#aacd001943085d888723268761022c88f">00067</a> <a class="code" href="network-mpi_8c.html#aacd001943085d888723268761022c88f">init_q</a>(<span class="keyword">struct</span> <a class="code" href="structact__q.html">act_q</a> *q, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">name</a>)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n;
<a name="l00070"></a>00070 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074   <span class="keywordflow">if</span>(q == &amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>)
<a name="l00075"></a>00075     n = <a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">send_buffer</a>;
<a name="l00076"></a>00076   <span class="keywordflow">else</span>
<a name="l00077"></a>00077     n = <a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a>;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   q-&gt;<a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">name</a> = <a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">name</a>;
<a name="l00080"></a>00080   q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a> = (<a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> **) <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, name, <span class="keyword">sizeof</span>(*q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>), n);
<a name="l00081"></a>00081   q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a> = (MPI_Request *) <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, name, <span class="keyword">sizeof</span>(*q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>), n);
<a name="l00082"></a>00082   q-&gt;<a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">idx_list</a> = (<span class="keywordtype">int</span> *) <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, name, <span class="keyword">sizeof</span>(*q-&gt;<a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">idx_list</a>), n);
<a name="l00083"></a>00083   q-&gt;<a class="code" href="structact__q.html#a1a280efeb12c61fba82288f089b271f3">status_list</a> = (MPI_Status *) <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, name, <span class="keyword">sizeof</span>(*q-&gt;<a class="code" href="structact__q.html#a1a280efeb12c61fba82288f089b271f3">status_list</a>), n);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>  q-&gt;buffers = <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, name, <span class="keyword">sizeof</span>(*q-&gt;buffers), n);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordflow">for</span>(i = 0; i &lt; n; i++)
<a name="l00089"></a>00089     q-&gt;buffers[i] = <a class="code" href="ross-extern_8h.html#a445b1ed30cd2e8ef1f837e782a339a70">tw_calloc</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="tw-memory_8h.html#a2af7acfd7247abafc131f33e4878e1ad">TW_MEMORY_BUFFER_SIZE</a>, 1);
<a name="l00090"></a>00090 <span class="preprocessor">#endif</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>}
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="ross-network_8h.html#aeb3412228db0c145431c083190281b36">00093</a> <a class="code" href="network-mpi_8h.html#aeaa3293f28d6ae6ecb9a8af470a392e2">tw_node</a> * <a class="code" href="network-mpi_8c.html#aeb3412228db0c145431c083190281b36">tw_net_onnode</a>(<a class="code" href="ross_8h.html#a1ec2e3807f66c4270f47acb0e555a519">tw_peid</a> gid) {
<a name="l00094"></a>00094   <a class="code" href="network-mpi_8c.html#a18cfc5d78424c8e766f64ca4fb150fd8">id_tmp</a> = gid;
<a name="l00095"></a>00095   <span class="keywordflow">return</span> &amp;<a class="code" href="network-mpi_8c.html#a18cfc5d78424c8e766f64ca4fb150fd8">id_tmp</a>;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00099"></a><a class="code" href="ross-network_8h.html#ab1ceb0df9f08e70f7e008dcc24adb425">00099</a> <a class="code" href="network-mpi_8c.html#a2818efb70df48e5e29d3dacb3e2de009">tw_nnodes</a>(<span class="keywordtype">void</span>)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101   <span class="keywordflow">return</span> <a class="code" href="network-mpi_8c.html#ab8411355a7d80016be6edcce3437b978">world_size</a>;
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="keywordtype">void</span>
<a name="l00105"></a><a class="code" href="ross-network_8h.html#a625a50a6a03701b067693d7dc5ed483b">00105</a> <a class="code" href="network-mpi_8c.html#a625a50a6a03701b067693d7dc5ed483b">tw_net_start</a>(<span class="keywordtype">void</span>)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107   <span class="keywordflow">if</span> (MPI_Comm_size(MPI_COMM_WORLD, &amp;<a class="code" href="network-mpi_8c.html#ab8411355a7d80016be6edcce3437b978">world_size</a>) != MPI_SUCCESS)
<a name="l00108"></a>00108     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Cannot get MPI_Comm_size(MPI_COMM_WORLD)&quot;</span>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <span class="keywordflow">if</span>( <a class="code" href="ross-extern_8h.html#aced8e9c1a7ab2577b8aed2f9c11468da">g_tw_mynode</a> == 0)
<a name="l00111"></a>00111     {
<a name="l00112"></a>00112       printf(<span class="stringliteral">&quot;tw_net_start: Found world size to be %d \n&quot;</span>, <a class="code" href="network-mpi_8c.html#ab8411355a7d80016be6edcce3437b978">world_size</a> );
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="comment">// Check after tw_nnodes is defined</span>
<a name="l00116"></a>00116   <span class="keywordflow">if</span>(<a class="code" href="network-mpi_8c.html#a2818efb70df48e5e29d3dacb3e2de009">tw_nnodes</a>() == 1 &amp;&amp; <a class="code" href="ross-extern_8h.html#ab70670daa39e7d964eef4b745914cffa">g_tw_npe</a> == 1) {
<a name="l00117"></a>00117       <span class="comment">// force the setting of SEQUENTIAL protocol</span>
<a name="l00118"></a>00118       <span class="keywordflow">if</span> (<a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fdae5f7a365677da0b0b9852a7b1c937f35">NO_SYNCH</a>) {
<a name="l00119"></a>00119           <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> = <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>;
<a name="l00120"></a>00120       } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda70cd78c3dbc0801ed52437fa82a6e8ef">CONSERVATIVE</a> || <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda7ff3894aed4e1746b6fb19f9472678c8">OPTIMISTIC</a>) {
<a name="l00121"></a>00121           <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> = <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda6b834d43476553e583e0fde6578c82f0">SEQUENTIAL</a>;
<a name="l00122"></a>00122           fprintf(stderr, <span class="stringliteral">&quot;Warning: Defaulting to Sequential Simulation, not enought PEs defined.\n&quot;</span>);
<a name="l00123"></a>00123       }
<a name="l00124"></a>00124   }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <a class="code" href="ross-extern_8h.html#a65d106a0c08e049457d6c747730bef97">tw_pe_create</a>(1);
<a name="l00127"></a>00127   <a class="code" href="ross-extern_8h.html#adc53c9a5b6d8f391eb4468183870307e">tw_pe_init</a>(0, <a class="code" href="ross-extern_8h.html#aced8e9c1a7ab2577b8aed2f9c11468da">g_tw_mynode</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129   <span class="comment">//If we&#39;re in (some variation of) optimistic mode, we need this hash</span>
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (<a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda7ff3894aed4e1746b6fb19f9472678c8">OPTIMISTIC</a> || <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fdacc902805d3a33320ec8f60c2add387ba">OPTIMISTIC_DEBUG</a>) {
<a name="l00131"></a>00131     <a class="code" href="ross-extern_8h.html#ae4fff7ff5b07598710d293ac564611f6">g_tw_pe</a>[0]-&gt;<a class="code" href="structtw__pe.html#ae5a648dd3ec46d9d3c9d9253603203e8" title="Array of incoming events from remote pes, Note: only necessary for distributed DSR.">hash_t</a> = <a class="code" href="hash-quadratic_8c.html#aebe8a594c0fe5a367f194e7ba7e1aa80">tw_hash_create</a>();
<a name="l00132"></a>00132   } <span class="keywordflow">else</span> {
<a name="l00133"></a>00133     <a class="code" href="ross-extern_8h.html#ae4fff7ff5b07598710d293ac564611f6">g_tw_pe</a>[0]-&gt;<a class="code" href="structtw__pe.html#ae5a648dd3ec46d9d3c9d9253603203e8" title="Array of incoming events from remote pes, Note: only necessary for distributed DSR.">hash_t</a> = NULL;
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="keywordflow">if</span> (<a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">send_buffer</a> &lt; 1)
<a name="l00137"></a>00137     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;network send buffer must be &gt;= 1&quot;</span>);
<a name="l00138"></a>00138   <span class="keywordflow">if</span> (<a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a> &lt; 1)
<a name="l00139"></a>00139     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;network read buffer must be &gt;= 1&quot;</span>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <a class="code" href="network-mpi_8c.html#aacd001943085d888723268761022c88f">init_q</a>(&amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>, <span class="stringliteral">&quot;MPI send queue&quot;</span>);
<a name="l00142"></a>00142   <a class="code" href="network-mpi_8c.html#aacd001943085d888723268761022c88f">init_q</a>(&amp;<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>, <span class="stringliteral">&quot;MPI recv queue&quot;</span>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <a class="code" href="ross-extern_8h.html#a76436337b648c7ac03476c9340387928">g_tw_net_device_size</a> = <a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a>;
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="keywordtype">void</span>
<a name="l00148"></a><a class="code" href="ross-network_8h.html#a53b310206267d968fc44cb574de00d80">00148</a> <a class="code" href="network-mpi_8c.html#a2e139e8547a091c4c4ea0b445fe8dd1c">tw_net_abort</a>(<span class="keywordtype">void</span>)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150   MPI_Abort(MPI_COMM_WORLD, 1);
<a name="l00151"></a>00151   exit(1);
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keywordtype">void</span>
<a name="l00155"></a><a class="code" href="ross-network_8h.html#a753856a718a9881f642523034260d3f9">00155</a> <a class="code" href="network-mpi_8c.html#a753856a718a9881f642523034260d3f9">tw_net_stop</a>(<span class="keywordtype">void</span>)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157   <span class="keywordflow">if</span> (MPI_Finalize() != MPI_SUCCESS)
<a name="l00158"></a>00158     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Failed to finalize MPI&quot;</span>);
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="keywordtype">void</span>
<a name="l00162"></a><a class="code" href="ross-network_8h.html#a5b9b1edd69f692ec139e387b03e75788">00162</a> <a class="code" href="network-mpi_8c.html#a5b9b1edd69f692ec139e387b03e75788">tw_net_barrier</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> * <a class="code" href="avl__tree_8c.html#ac4c639748d4d5a271d6c54a18f614605">pe</a>)
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164   <span class="keywordflow">if</span> (MPI_Barrier(MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00165"></a>00165     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Failed to wait for MPI_Barrier&quot;</span>);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <a class="code" href="ross_8h.html#a80b370bc538e17441aef6afaff852678">tw_stime</a>
<a name="l00169"></a><a class="code" href="ross-network_8h.html#a3f03ef53bc49044f077ff1482600083c">00169</a> <a class="code" href="network-mpi_8c.html#ad4050f9a1a178291ab420afb22f1b05f">tw_net_minimum</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171   <a class="code" href="ross_8h.html#a80b370bc538e17441aef6afaff852678">tw_stime</a> m = DBL_MAX;
<a name="l00172"></a>00172   <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e;
<a name="l00173"></a>00173   <span class="keywordtype">int</span> i;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   e = outq.<a class="code" href="structtw__eventq.html#a0a1d2a79704a9bb361cbc1c1a1f67952">head</a>;
<a name="l00176"></a>00176   <span class="keywordflow">while</span> (e) {
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (m &gt; e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>)
<a name="l00178"></a>00178       m = e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>;
<a name="l00179"></a>00179     e = e-&gt;<a class="code" href="structtw__event.html#a4e59fdcbe04117541f00ec8711d3b750">next</a>;
<a name="l00180"></a>00180   }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>; i++) {
<a name="l00183"></a>00183     e = <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[i];
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (m &gt; e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>)
<a name="l00185"></a>00185       m = e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>;
<a name="l00186"></a>00186   }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="keywordflow">return</span> m;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00192"></a><a class="code" href="network-mpi_8c.html#a3a991bb1d1d24fbb8695947451f3f765">00192</a> <a class="code" href="network-mpi_8c.html#a3a991bb1d1d24fbb8695947451f3f765">test_q</a>(
<a name="l00193"></a>00193        <span class="keyword">struct</span> <a class="code" href="structact__q.html">act_q</a> *q,
<a name="l00194"></a>00194        <a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me,
<a name="l00195"></a>00195        <span class="keywordtype">void</span> (*finish)(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *, <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *, <span class="keywordtype">char</span> *))
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197   <span class="keywordtype">int</span> ready, i, n;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>  <span class="keywordtype">char</span> *tmp;
<a name="l00201"></a>00201 <span class="preprocessor">#endif</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>
<a name="l00203"></a>00203   <span class="keywordflow">if</span> (!q-&gt;<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>)
<a name="l00204"></a>00204     <span class="keywordflow">return</span> 0;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="keywordflow">if</span> (MPI_Testsome(
<a name="l00207"></a>00207                    q-&gt;<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>,
<a name="l00208"></a>00208                    q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>,
<a name="l00209"></a>00209                    &amp;ready,
<a name="l00210"></a>00210                    q-&gt;<a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">idx_list</a>,
<a name="l00211"></a>00211                    q-&gt;<a class="code" href="structact__q.html#a1a280efeb12c61fba82288f089b271f3">status_list</a>) != MPI_SUCCESS) {
<a name="l00212"></a>00212     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(
<a name="l00213"></a>00213              <a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>,
<a name="l00214"></a>00214              <span class="stringliteral">&quot;MPI_testsome failed with %u items in %s&quot;</span>,
<a name="l00215"></a>00215              q-&gt;<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>,
<a name="l00216"></a>00216              q-&gt;<a class="code" href="structact__q.html#a3a30714e462936c644cafdded65af61c">name</a>);
<a name="l00217"></a>00217   }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   <span class="keywordflow">if</span> (1 &gt; ready)
<a name="l00220"></a>00220     <span class="keywordflow">return</span> 0;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="keywordflow">for</span> (i = 0; i &lt; ready; i++)
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224       <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226       n = q-&gt;<a class="code" href="structact__q.html#a4173587349856c04cac8a9250a16ad21">idx_list</a>[i];
<a name="l00227"></a>00227       e = q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[n];
<a name="l00228"></a>00228       q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[n] = NULL;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>      finish(me, e, q-&gt;buffers[n]);
<a name="l00232"></a>00232 <span class="preprocessor">#else</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>      finish(me, e, NULL);
<a name="l00234"></a>00234 <span class="preprocessor">#endif</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>    }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="comment">/* Collapse the lists to remove any holes we left. */</span>
<a name="l00238"></a>00238   <span class="keywordflow">for</span> (i = 0, n = 0; i &lt; q-&gt;<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>; i++) {
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[i]) {
<a name="l00240"></a>00240       <span class="keywordflow">if</span> (i != n) {
<a name="l00241"></a>00241         <span class="comment">// swap the event pointers</span>
<a name="l00242"></a>00242         q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[n] = q-&gt;<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[i];
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="comment">// copy the request handles</span>
<a name="l00245"></a>00245         memcpy(
<a name="l00246"></a>00246                &amp;q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[n],
<a name="l00247"></a>00247                &amp;q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[i],
<a name="l00248"></a>00248                <span class="keyword">sizeof</span>(q-&gt;<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[0]));
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>        <span class="comment">// swap the buffers</span>
<a name="l00252"></a>00252         tmp = q-&gt;buffers[n];
<a name="l00253"></a>00253         q-&gt;buffers[n] = q-&gt;buffers[i];
<a name="l00254"></a>00254         q-&gt;buffers[i] = tmp;
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>      }
<a name="l00257"></a>00257       n++;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260   q-&gt;<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a> -= ready;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   <span class="keywordflow">return</span> 1;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00266"></a><a class="code" href="network-mpi_8c.html#a90b2df9e7fdef6bca9bd7e3f7ff6a294">00266</a> <a class="code" href="network-mpi_8c.html#a90b2df9e7fdef6bca9bd7e3f7ff6a294">recv_begin</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me)
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268   MPI_Status status;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a>      *e = NULL;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   <span class="keywordtype">int</span> flag = 0;
<a name="l00273"></a>00273   <span class="keywordtype">int</span> changed = 0;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275   <span class="keywordflow">while</span> (<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a> &lt; <a class="code" href="network-mpi_8c.html#a7ecd52e7fd90bbbcee7bd64df018073f">read_buffer</a>)
<a name="l00276"></a>00276     {
<a name="l00277"></a>00277       <span class="keywordtype">unsigned</span> <span class="keywordtype">id</span> = <a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279       MPI_Iprobe(MPI_ANY_SOURCE,
<a name="l00280"></a>00280                  MPI_ANY_TAG,
<a name="l00281"></a>00281                  MPI_COMM_WORLD,
<a name="l00282"></a>00282                  &amp;flag,
<a name="l00283"></a>00283                  &amp;status);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       <span class="keywordflow">if</span>(flag)
<a name="l00286"></a>00286         {
<a name="l00287"></a>00287           <span class="keywordflow">if</span>(!(e = <a class="code" href="ross-inline_8h.html#a91ee3bf5565bdad184cf16590b6b3198">tw_event_grab</a>(me)))
<a name="l00288"></a>00288             {
<a name="l00289"></a>00289               <span class="keywordflow">if</span>(<a class="code" href="mpi__allreduce_8h.html#a7a58c92b0e80a7be5f3a741f75df71f8">tw_gvt_inprogress</a>(me))
<a name="l00290"></a>00290                 <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;out of events in GVT!&quot;</span>);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292               <span class="keywordflow">break</span>;
<a name="l00293"></a>00293             }
<a name="l00294"></a>00294         } <span class="keywordflow">else</span>
<a name="l00295"></a>00295         {
<a name="l00296"></a>00296           <span class="keywordflow">return</span> changed;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(!flag || 
<a name="l00301"></a>00301          MPI_Irecv(<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.buffers[<span class="keywordtype">id</span>],
<a name="l00302"></a>00302                    <a class="code" href="network-mpi_8c.html#a5a389c807591f69a3806763bc9c089fa">EVENT_SIZE</a>(e),
<a name="l00303"></a>00303                    MPI_BYTE,
<a name="l00304"></a>00304                    MPI_ANY_SOURCE,
<a name="l00305"></a>00305                    <a class="code" href="network-mpi_8c.html#a21f58374b1b9d28d08d7f4eabddbba82">EVENT_TAG</a>,
<a name="l00306"></a>00306                    MPI_COMM_WORLD,
<a name="l00307"></a>00307                    &amp;<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[<span class="keywordtype">id</span>]) != MPI_SUCCESS)
<a name="l00308"></a>00308 <span class="preprocessor">#else</span>
<a name="l00309"></a>00309 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(!flag || 
<a name="l00310"></a>00310            MPI_Irecv(e,
<a name="l00311"></a>00311                      (<span class="keywordtype">int</span>)<a class="code" href="network-mpi_8c.html#a5a389c807591f69a3806763bc9c089fa">EVENT_SIZE</a>(e),
<a name="l00312"></a>00312                      MPI_BYTE,
<a name="l00313"></a>00313                      MPI_ANY_SOURCE,
<a name="l00314"></a>00314                      <a class="code" href="network-mpi_8c.html#a21f58374b1b9d28d08d7f4eabddbba82">EVENT_TAG</a>,
<a name="l00315"></a>00315                      MPI_COMM_WORLD,
<a name="l00316"></a>00316                      &amp;<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[<span class="keywordtype">id</span>]) != MPI_SUCCESS)
<a name="l00317"></a>00317 <span class="preprocessor">#endif</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>          {
<a name="l00319"></a>00319             <a class="code" href="ross-extern_8h.html#a5215643013906a13f0e2febadd0b0473">tw_event_free</a>(me, e);
<a name="l00320"></a>00320             <span class="keywordflow">return</span> changed;
<a name="l00321"></a>00321           }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       <a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[id] = e;
<a name="l00324"></a>00324       <a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>++;
<a name="l00325"></a>00325       changed = 1;
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   <span class="keywordflow">return</span> changed;
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00332"></a><a class="code" href="network-mpi_8c.html#a149ffcda6e9840d885bfe970374a9f49">00332</a> <a class="code" href="network-mpi_8c.html#a149ffcda6e9840d885bfe970374a9f49">recv_finish</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me, <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e, <span class="keywordtype">char</span> * buffer)
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334   <a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a>         *dest_pe;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>  tw_memory     *memory;
<a name="l00338"></a>00338   tw_memory     *last;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340   <a class="code" href="ross-types_8h.html#ad3b32ef512317814643a01795a8a478f">tw_fd</a>          mem_fd;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342   <span class="keywordtype">size_t</span>                 mem_size;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   <span class="keywordtype">unsigned</span>       position = 0;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   memcpy(e, buffer, <a class="code" href="ross-extern_8h.html#a8cb2af58d38e8678188b3f66b4ae552c">g_tw_event_msg_sz</a>);
<a name="l00347"></a>00347   position += <a class="code" href="ross-extern_8h.html#a8cb2af58d38e8678188b3f66b4ae552c">g_tw_event_msg_sz</a>;
<a name="l00348"></a>00348 <span class="preprocessor">#endif</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span>
<a name="l00350"></a>00350   me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a67369ce1343843fe5d0bb6f723ccb140">s_nread_network</a>++;
<a name="l00351"></a>00351   me-&gt;<a class="code" href="structtw__pe.html#ab0e5e3bc50c10def6a57f8bc680e6a1a">s_nwhite_recv</a>++;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a> = <a class="code" href="ross-kernel-inline_8h.html#a3e5591d29e9db9c6a1a1cc19ed55feec">tw_getlocal_lp</a>((<a class="code" href="ross_8h.html#a911515dff2fb79886a16ed44df5f9d20">tw_lpid</a>) e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a>);
<a name="l00354"></a>00354   dest_pe = e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a>-&gt;<a class="code" href="structtw__lp.html#a9fd32632e5c45a00faf16a6fd0814640">pe</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a> &gt; <a class="code" href="network-mpi_8c.html#a2818efb70df48e5e29d3dacb3e2de009">tw_nnodes</a>()-1)
<a name="l00357"></a>00357     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;bad sendpe_id: %d&quot;</span>, e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   e-&gt;<a class="code" href="structtw__event.html#aa85d9f587fd15552d51d08c7b2b392ac" title="Next event in the cancel queue for the dest_pe.">cancel_next</a> = NULL;
<a name="l00360"></a>00360   e-&gt;<a class="code" href="structtw__event.html#a79a3d7a01afbd191b3e134cd3980fc15" title="Start of event list caused by this event.">caused_by_me</a> = NULL;
<a name="l00361"></a>00361   e-&gt;<a class="code" href="structtw__event.html#aac80968705fca84ecb01e83ea46419f3" title="Next in parent&#39;s caused_by_me chain.">cause_next</a> = NULL;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a> &lt; me-&gt;<a class="code" href="structtw__pe.html#a3f82dbbf2dbb0163b6078ff25cb75a1b" title="Global Virtual Time.">GVT</a>)
<a name="l00364"></a>00364     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;%d: Received straggler from %d: %lf (%d)&quot;</span>, 
<a name="l00365"></a>00365              me-&gt;<a class="code" href="structtw__pe.html#a8a57f2123eddf6a195d82ecc781093e6">id</a>,  e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a>, e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>, e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a>);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   <span class="keywordflow">if</span>(<a class="code" href="mpi__allreduce_8h.html#a7a58c92b0e80a7be5f3a741f75df71f8">tw_gvt_inprogress</a>(me))
<a name="l00368"></a>00368     me-&gt;<a class="code" href="structtw__pe.html#a63048ba8f41665780ab46b3b6635ae91" title="Last transient messages&#39; time stamp.">trans_msg_ts</a> = <a class="code" href="ross-kernel-inline_8h.html#a76b22a7896601c622802f236cae6684a">ROSS_MIN</a>(me-&gt;<a class="code" href="structtw__pe.html#a63048ba8f41665780ab46b3b6635ae91" title="Last transient messages&#39; time stamp.">trans_msg_ts</a>, e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a>);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <span class="comment">// if cancel event, retrieve and flush</span>
<a name="l00371"></a>00371   <span class="comment">// else, store in hash table</span>
<a name="l00372"></a>00372   <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a>)
<a name="l00373"></a>00373     {
<a name="l00374"></a>00374       <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *cancel = <a class="code" href="hash-quadratic_8c.html#af2da87c210aeb3433d50ee3bcb139e20">tw_hash_remove</a>(me-&gt;<a class="code" href="structtw__pe.html#ae5a648dd3ec46d9d3c9d9253603203e8" title="Array of incoming events from remote pes, Note: only necessary for distributed DSR.">hash_t</a>, e, e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a>);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376       <span class="comment">// NOTE: it is possible to cancel the event we</span>
<a name="l00377"></a>00377       <span class="comment">// are currently processing at this PE since this</span>
<a name="l00378"></a>00378       <span class="comment">// MPI module lets me read cancel events during </span>
<a name="l00379"></a>00379       <span class="comment">// event sends over the network.</span>
<a name="l00380"></a>00380 
<a name="l00381"></a>00381       cancel-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a> = 1;
<a name="l00382"></a>00382       cancel-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a5f5d71c18132da4f3412f48394413d92" title="Indicates union addr is in &#39;remote&#39; storage.">remote</a> = 0;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       cancel-&gt;<a class="code" href="structtw__event.html#aa85d9f587fd15552d51d08c7b2b392ac" title="Next event in the cancel queue for the dest_pe.">cancel_next</a> = dest_pe-&gt;<a class="code" href="structtw__pe.html#a682bbfd605f12208413174e31220d26c" title="List of canceled events.">cancel_q</a>;
<a name="l00385"></a>00385       dest_pe-&gt;<a class="code" href="structtw__pe.html#a682bbfd605f12208413174e31220d26c" title="List of canceled events.">cancel_q</a> = cancel;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       <a class="code" href="ross-extern_8h.html#a5215643013906a13f0e2febadd0b0473">tw_event_free</a>(me, e);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389       <span class="keywordflow">return</span>;
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392   <span class="keywordflow">if</span> (<a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda7ff3894aed4e1746b6fb19f9472678c8">OPTIMISTIC</a> || <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fdacc902805d3a33320ec8f60c2add387ba">OPTIMISTIC_DEBUG</a>) {
<a name="l00393"></a>00393     <a class="code" href="hash-quadratic_8c.html#a4e8a48f209c2574ac4755605ac42f773">tw_hash_insert</a>(me-&gt;<a class="code" href="structtw__pe.html#ae5a648dd3ec46d9d3c9d9253603203e8" title="Array of incoming events from remote pes, Note: only necessary for distributed DSR.">hash_t</a>, e, e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a>);
<a name="l00394"></a>00394     e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a5f5d71c18132da4f3412f48394413d92" title="Indicates union addr is in &#39;remote&#39; storage.">remote</a> = 1;
<a name="l00395"></a>00395   }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>  mem_size = (size_t) e-&gt;memory;
<a name="l00399"></a>00399   mem_fd = (<a class="code" href="ross-types_8h.html#ad3b32ef512317814643a01795a8a478f">tw_fd</a>) e-&gt;<a class="code" href="structtw__event.html#adf9d923fa55a01e84d43ce33d1345764">prev</a>;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   last = NULL;
<a name="l00402"></a>00402   <span class="keywordflow">while</span>(mem_size)
<a name="l00403"></a>00403     {
<a name="l00404"></a>00404       memory = <a class="code" href="tw-memory_8h.html#aed22291dc741aae2901611db42e4946d">tw_memory_alloc</a>(e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a>, mem_fd);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406       <span class="keywordflow">if</span>(last)
<a name="l00407"></a>00407         last-&gt;next = memory;
<a name="l00408"></a>00408       <span class="keywordflow">else</span>
<a name="l00409"></a>00409         e-&gt;memory = memory;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411       memcpy(memory, &amp;buffer[position], mem_size);
<a name="l00412"></a>00412       position += mem_size;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414       memory-&gt;fd = mem_fd;
<a name="l00415"></a>00415       memory-&gt;nrefs = 1;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       mem_size = (size_t) memory-&gt;next;
<a name="l00418"></a>00418       mem_fd = memory-&gt;fd;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420       last = memory;
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 <span class="preprocessor">#endif</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>
<a name="l00424"></a>00424   <span class="comment">/* NOTE: the final check in the if conditional below was added to make sure</span>
<a name="l00425"></a>00425 <span class="comment">   * that we do not execute the fast case unless the cancellation queue is</span>
<a name="l00426"></a>00426 <span class="comment">   * empty on the destination PE.  Otherwise we need to invoke the normal</span>
<a name="l00427"></a>00427 <span class="comment">   * scheduling routines to make sure that a forward event doesn&#39;t bypass a</span>
<a name="l00428"></a>00428 <span class="comment">   * cancellation event with an earlier timestamp.  This is helpful for</span>
<a name="l00429"></a>00429 <span class="comment">   * stateful models that produce incorrect results when presented with</span>
<a name="l00430"></a>00430 <span class="comment">   * duplicate messages with no rollback between them.</span>
<a name="l00431"></a>00431 <span class="comment">   */</span>
<a name="l00432"></a>00432   <span class="keywordflow">if</span>(me == dest_pe &amp;&amp; e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a>-&gt;<a class="code" href="structtw__lp.html#a8028662b2668953fa9f49f2df7d00850" title="kp -- Kernel process that we belong to (must match pe).">kp</a>-&gt;<a class="code" href="structtw__kp.html#aabf1253aa1eb55c613a70fb3c9271117" title="Time of the current event being processed.">last_time</a> &lt;= e-&gt;<a class="code" href="structtw__event.html#a4e32bfdbde0d1cae06b5b3fb90adbffa" title="Actual time to be received.">recv_ts</a> &amp;&amp; !dest_pe-&gt;<a class="code" href="structtw__pe.html#a682bbfd605f12208413174e31220d26c" title="List of canceled events.">cancel_q</a>) {
<a name="l00433"></a>00433     <span class="comment">/* Fast case, we are sending to our own PE and</span>
<a name="l00434"></a>00434 <span class="comment">     * there is no rollback caused by this send.</span>
<a name="l00435"></a>00435 <span class="comment">     */</span>
<a name="l00436"></a>00436     <a class="code" href="splay_8c.html#a60a6784c1d092ff7ddf96cf6762d7b9e">tw_pq_enqueue</a>(dest_pe-&gt;<a class="code" href="structtw__pe.html#a90e1dbe51a084d6e02580667159e13ff" title="Priority queue used to sort events.">pq</a>, e);
<a name="l00437"></a>00437     <span class="keywordflow">return</span>;
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="keywordflow">if</span> (me-&gt;<a class="code" href="structtw__pe.html#a1fbe95f259e0ea7ee230a50662d18185">node</a> == dest_pe-&gt;<a class="code" href="structtw__pe.html#a1fbe95f259e0ea7ee230a50662d18185">node</a>) {
<a name="l00441"></a>00441     <span class="comment">/* Slower, but still local send, so put into top</span>
<a name="l00442"></a>00442 <span class="comment">     * of dest_pe-&gt;event_q. </span>
<a name="l00443"></a>00443 <span class="comment">     */</span>
<a name="l00444"></a>00444     e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> = <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a26a5d83ab76e077bf87d5e9a92fa5cf6" title="In a tw_pe.event_q list.">TW_pe_event_q</a>;
<a name="l00445"></a>00445     <a class="code" href="tw-eventq_8h.html#a5c324b9c5a53c17e78709fa7eaaa7a1f">tw_eventq_push</a>(&amp;dest_pe-&gt;<a class="code" href="structtw__pe.html#a3164a458415135a6b5310d5f2394202a" title="Linked list of events sent to this PE.">event_q</a>, e);
<a name="l00446"></a>00446     <span class="keywordflow">return</span>;
<a name="l00447"></a>00447   }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   <span class="comment">/* Never should happen; MPI should have gotten the</span>
<a name="l00450"></a>00450 <span class="comment">   * message to the correct node without needing us</span>
<a name="l00451"></a>00451 <span class="comment">   * to redirect the message there for it.  This is</span>
<a name="l00452"></a>00452 <span class="comment">   * probably a serious bug with the event headers</span>
<a name="l00453"></a>00453 <span class="comment">   * not being formatted right.</span>
<a name="l00454"></a>00454 <span class="comment">   */</span>
<a name="l00455"></a>00455   <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(
<a name="l00456"></a>00456            <a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>,
<a name="l00457"></a>00457            <span class="stringliteral">&quot;Event recived by PE %u but meant for PE %u&quot;</span>,
<a name="l00458"></a>00458            me-&gt;<a class="code" href="structtw__pe.html#a8a57f2123eddf6a195d82ecc781093e6">id</a>,
<a name="l00459"></a>00459            dest_pe-&gt;<a class="code" href="structtw__pe.html#a8a57f2123eddf6a195d82ecc781093e6">id</a>);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00463"></a><a class="code" href="network-mpi_8c.html#a4e1e1bd17bf05f66af5628d37dd9af9d">00463</a> <a class="code" href="network-mpi_8c.html#a4e1e1bd17bf05f66af5628d37dd9af9d">send_begin</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465   <span class="keywordtype">int</span> changed = 0;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467   <span class="keywordflow">while</span> (<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a> &lt; <a class="code" href="network-mpi_8c.html#aaf9f9bebe685a2f4933a4d9d0a164f65">send_buffer</a>)
<a name="l00468"></a>00468     {
<a name="l00469"></a>00469       <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e = <a class="code" href="tw-eventq_8h.html#ab24e28ddbfec88a67c6c4be13be13d60">tw_eventq_peek</a>(&amp;outq);
<a name="l00470"></a>00470       <a class="code" href="network-mpi_8h.html#aeaa3293f28d6ae6ecb9a8af470a392e2">tw_node</a>   *dest_node = NULL;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472       <span class="keywordtype">unsigned</span> <span class="keywordtype">id</span> = <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>      <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *tmp_prev = NULL;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477       <a class="code" href="structtw__lp.html" title="LP State Structure.">tw_lp</a> *tmp_lp = NULL;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479       tw_memory *memory = NULL;
<a name="l00480"></a>00480       tw_memory *m = NULL;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482       <span class="keywordtype">char</span> *buffer = NULL;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484       <span class="keywordtype">size_t</span> mem_size = 0;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486       <span class="keywordtype">unsigned</span> position = 0;
<a name="l00487"></a>00487 <span class="preprocessor">#endif</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>
<a name="l00489"></a>00489       <span class="keywordflow">if</span> (!e)
<a name="l00490"></a>00490         <span class="keywordflow">break</span>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <span class="keywordflow">if</span>(e == me-&gt;<a class="code" href="structtw__pe.html#a76e88f72d90635b512db0ba17d570e2f" title="Placeholder event for when free_q is empty.">abort_event</a>)
<a name="l00493"></a>00493         <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Sending abort event!&quot;</span>);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495       dest_node = <a class="code" href="network-mpi_8c.html#aeb3412228db0c145431c083190281b36">tw_net_onnode</a>((*e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a>-&gt;<a class="code" href="structtw__lp.html#a205f09ff294b6bb1f61eab7b099ebea2" title="Type of this LP, including service callbacks.">type</a>-&gt;<a class="code" href="structtw__lptype.html#a318b36c6d9614b4393a3fa010cb84a14" title="LP Mapping of LP gid -&gt; remote PE routine.">map</a>)
<a name="l00496"></a>00496                                 ((<a class="code" href="ross_8h.html#a911515dff2fb79886a16ed44df5f9d20">tw_lpid</a>) e-&gt;<a class="code" href="structtw__event.html#afbd71fb6565dd9a4de0ad8e77e748c8a" title="Destination LP ID.">dest_lp</a>));
<a name="l00497"></a>00497 
<a name="l00498"></a>00498       <span class="keywordflow">if</span>(!e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a>)
<a name="l00499"></a>00499         e-&gt;<a class="code" href="structtw__event.html#ae5758679ad5688685478da7f4256725d" title="Unique id assigned by src_lp-&gt;pe if remote.">event_id</a> = (<a class="code" href="network-mpi_8h.html#aec5cb2bd2e05292a8f326a7b2358ee03">tw_eventid</a>) ++me-&gt;<a class="code" href="structtw__pe.html#af05df69f14217e3d596ad127b3bee586" title="Array of remote send counters for hashing on, size == g_tw_npe.">seq_num</a>;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501       e-&gt;<a class="code" href="structtw__event.html#af17bb0c089b131142a2cb9c98bee0753">send_pe</a> = (<a class="code" href="ross_8h.html#a1ec2e3807f66c4270f47acb0e555a519">tw_peid</a>) <a class="code" href="ross-extern_8h.html#aced8e9c1a7ab2577b8aed2f9c11468da">g_tw_mynode</a>;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="preprocessor">#if ROSS_MEMORY</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>      <span class="comment">// pack pointers</span>
<a name="l00505"></a>00505       tmp_prev = e-&gt;<a class="code" href="structtw__event.html#adf9d923fa55a01e84d43ce33d1345764">prev</a>;
<a name="l00506"></a>00506       tmp_lp = e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508       <span class="comment">// delete when working</span>
<a name="l00509"></a>00509       e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a> = NULL;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511       memory = NULL;
<a name="l00512"></a>00512       <span class="keywordflow">if</span>(e-&gt;memory)
<a name="l00513"></a>00513         {
<a name="l00514"></a>00514           memory = e-&gt;memory;
<a name="l00515"></a>00515           e-&gt;memory = (tw_memory *) <a class="code" href="tw-memory_8h.html#a0cb249399b85349d846f35ed1d5e0a18">tw_memory_getsize</a>(me, memory-&gt;fd);
<a name="l00516"></a>00516           e-&gt;<a class="code" href="structtw__event.html#adf9d923fa55a01e84d43ce33d1345764">prev</a> = (<a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *) memory-&gt;fd;
<a name="l00517"></a>00517           mem_size = (<span class="keywordtype">size_t</span>) e-&gt;memory;
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520       buffer = <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.buffers[id];
<a name="l00521"></a>00521       memcpy(&amp;buffer[position], e, <a class="code" href="ross-extern_8h.html#a8cb2af58d38e8678188b3f66b4ae552c">g_tw_event_msg_sz</a>);
<a name="l00522"></a>00522       position += <a class="code" href="ross-extern_8h.html#a8cb2af58d38e8678188b3f66b4ae552c">g_tw_event_msg_sz</a>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524       <span class="comment">// restore pointers</span>
<a name="l00525"></a>00525       e-&gt;<a class="code" href="structtw__event.html#adf9d923fa55a01e84d43ce33d1345764">prev</a> = tmp_prev;
<a name="l00526"></a>00526       e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a> = tmp_lp;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528       m = NULL;
<a name="l00529"></a>00529       <span class="keywordflow">while</span>(memory)
<a name="l00530"></a>00530         {
<a name="l00531"></a>00531           m = memory-&gt;next;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533           <span class="keywordflow">if</span>(m)
<a name="l00534"></a>00534             {
<a name="l00535"></a>00535               memory-&gt;next = (tw_memory *)
<a name="l00536"></a>00536                 <a class="code" href="tw-memory_8h.html#a0cb249399b85349d846f35ed1d5e0a18">tw_memory_getsize</a>(me, m-&gt;fd);
<a name="l00537"></a>00537               memory-&gt;fd = m-&gt;fd;
<a name="l00538"></a>00538             }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540           <span class="keywordflow">if</span>(position + mem_size &gt; <a class="code" href="tw-memory_8h.html#a2af7acfd7247abafc131f33e4878e1ad">TW_MEMORY_BUFFER_SIZE</a>)
<a name="l00541"></a>00541             <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Out of buffer space!&quot;</span>);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543           memcpy(&amp;buffer[position], memory, mem_size);
<a name="l00544"></a>00544           position += mem_size;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546           memory-&gt;nrefs--;
<a name="l00547"></a>00547           <a class="code" href="tw-memory_8h.html#aedd984238ab20d02262e2d6d5363fe30">tw_memory_unshift</a>(e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a>, memory, memory-&gt;fd);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549           <span class="keywordflow">if</span>(NULL != (memory = m))
<a name="l00550"></a>00550             mem_size = <a class="code" href="tw-memory_8h.html#a0cb249399b85349d846f35ed1d5e0a18">tw_memory_getsize</a>(me, memory-&gt;fd);
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553       e-&gt;memory = NULL;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       <span class="keywordflow">if</span> (MPI_Isend(buffer,
<a name="l00556"></a>00556                     <a class="code" href="network-mpi_8c.html#a5a389c807591f69a3806763bc9c089fa">EVENT_SIZE</a>(e),
<a name="l00557"></a>00557                     MPI_BYTE,
<a name="l00558"></a>00558                     *dest_node,
<a name="l00559"></a>00559                     <a class="code" href="network-mpi_8c.html#a21f58374b1b9d28d08d7f4eabddbba82">EVENT_TAG</a>,
<a name="l00560"></a>00560                     MPI_COMM_WORLD,
<a name="l00561"></a>00561                     &amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[<span class="keywordtype">id</span>]) != MPI_SUCCESS) {
<a name="l00562"></a>00562         <span class="keywordflow">return</span> changed;
<a name="l00563"></a>00563       }
<a name="l00564"></a>00564 <span class="preprocessor">#else</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (MPI_Isend(e,
<a name="l00566"></a>00566                     (<span class="keywordtype">int</span>)<a class="code" href="network-mpi_8c.html#a5a389c807591f69a3806763bc9c089fa">EVENT_SIZE</a>(e),
<a name="l00567"></a>00567                     MPI_BYTE,
<a name="l00568"></a>00568                     (<span class="keywordtype">int</span>)*dest_node,
<a name="l00569"></a>00569                     <a class="code" href="network-mpi_8c.html#a21f58374b1b9d28d08d7f4eabddbba82">EVENT_TAG</a>,
<a name="l00570"></a>00570                     MPI_COMM_WORLD,
<a name="l00571"></a>00571                     &amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#a45dfcb267bc21a2f248f1befb03eba08">req_list</a>[<span class="keywordtype">id</span>]) != MPI_SUCCESS) {
<a name="l00572"></a>00572         <span class="keywordflow">return</span> changed;
<a name="l00573"></a>00573       }
<a name="l00574"></a>00574 <span class="preprocessor">#endif</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>
<a name="l00576"></a>00576       <a class="code" href="tw-eventq_8h.html#aa40bc1edebb9f58d87092388cf8dc0df">tw_eventq_pop</a>(&amp;outq);
<a name="l00577"></a>00577       e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> = e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a>
<a name="l00578"></a>00578         ? <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a90edf12a62665936dab4975c81dafc3c" title="Network transmission in progress.">TW_net_acancel</a>
<a name="l00579"></a>00579         : <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a713a9666a4105fa38cb1545087a38b44" title="Network transmission in progress.">TW_net_asend</a>;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581       <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#a1cb41daa0b55bbf70d086718e7eb9812">event_list</a>[id] = e;
<a name="l00582"></a>00582       <a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>.<a class="code" href="structact__q.html#aa1dee68659ef0605959585bff0365e3f">cur</a>++;
<a name="l00583"></a>00583       me-&gt;<a class="code" href="structtw__pe.html#ad7f2118d4584a910f40850a2fdc1c9ef">s_nwhite_sent</a>++;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585       changed = 1;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587   <span class="keywordflow">return</span> changed;
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00591"></a><a class="code" href="network-mpi_8c.html#a08594cce713aee586b50774147ce63df">00591</a> <a class="code" href="network-mpi_8c.html#a08594cce713aee586b50774147ce63df">send_finish</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me, <a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e, <span class="keywordtype">char</span> * buffer)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593   me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a950bfd3cce9aeb0874095350d634e977">s_nsend_network</a>++;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> == <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a713a9666a4105fa38cb1545087a38b44" title="Network transmission in progress.">TW_net_asend</a>) {
<a name="l00596"></a>00596     <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#ac5983e758d7e1fd013dcda1ec5f848f1">cancel_asend</a>) {
<a name="l00597"></a>00597       <span class="comment">/* Event was cancelled during transmission.  We must</span>
<a name="l00598"></a>00598 <span class="comment">       * send another message to pass the cancel flag to</span>
<a name="l00599"></a>00599 <span class="comment">       * the other node.</span>
<a name="l00600"></a>00600 <span class="comment">       */</span>
<a name="l00601"></a>00601       e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#ac5983e758d7e1fd013dcda1ec5f848f1">cancel_asend</a> = 0;
<a name="l00602"></a>00602       e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a> = 1;
<a name="l00603"></a>00603       <a class="code" href="tw-eventq_8h.html#a5c324b9c5a53c17e78709fa7eaaa7a1f">tw_eventq_push</a>(&amp;outq, e);
<a name="l00604"></a>00604     } <span class="keywordflow">else</span> {
<a name="l00605"></a>00605       <span class="comment">/* Event finished transmission and was not cancelled.</span>
<a name="l00606"></a>00606 <span class="comment">       * Add to our sent event queue so we can retain the</span>
<a name="l00607"></a>00607 <span class="comment">       * event in case we need to cancel it later.  Note it</span>
<a name="l00608"></a>00608 <span class="comment">       * is currently in remote format and must be converted</span>
<a name="l00609"></a>00609 <span class="comment">       * back to local format for fossil collection.</span>
<a name="l00610"></a>00610 <span class="comment">       */</span>
<a name="l00611"></a>00611       e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> = <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a2aa790f48e8249fb18b1739b7cf9fef0" title="In tw_pe.sevent_q.">TW_pe_sevent_q</a>;
<a name="l00612"></a>00612       <span class="keywordflow">if</span>( <a class="code" href="ross-extern_8h.html#ae22db4d4e754eff64535402f5fa60a5f">g_tw_synchronization_protocol</a> == <a class="code" href="ross-types_8h.html#abea764c61c75c56008ccf665a71246fda70cd78c3dbc0801ed52437fa82a6e8ef">CONSERVATIVE</a> )
<a name="l00613"></a>00613         <a class="code" href="ross-extern_8h.html#a5215643013906a13f0e2febadd0b0473">tw_event_free</a>(me, e);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">return</span>;
<a name="l00617"></a>00617   }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> == <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a90edf12a62665936dab4975c81dafc3c" title="Network transmission in progress.">TW_net_acancel</a>) {
<a name="l00620"></a>00620     <span class="comment">/* We just finished sending the cancellation message</span>
<a name="l00621"></a>00621 <span class="comment">     * for this event.  We need to free the buffer and</span>
<a name="l00622"></a>00622 <span class="comment">     * make it available for reuse.</span>
<a name="l00623"></a>00623 <span class="comment">     */</span>
<a name="l00624"></a>00624     <a class="code" href="ross-extern_8h.html#a5215643013906a13f0e2febadd0b0473">tw_event_free</a>(me, e);
<a name="l00625"></a>00625     <span class="keywordflow">return</span>;
<a name="l00626"></a>00626   }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <span class="comment">/* Never should happen, not unless we somehow broke this</span>
<a name="l00629"></a>00629 <span class="comment">   * module&#39;s other functions related to sending an event.</span>
<a name="l00630"></a>00630 <span class="comment">   */</span>
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(
<a name="l00633"></a>00633            <a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>,
<a name="l00634"></a>00634            <span class="stringliteral">&quot;Don&#39;t know how to finish send of owner=%u, cancel_q=%d&quot;</span>,
<a name="l00635"></a>00635            e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a>,
<a name="l00636"></a>00636            e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a>);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00641"></a><a class="code" href="network-mpi_8c.html#a8705ab243733bb856d58534e0e853da3">00641</a> <a class="code" href="network-mpi_8c.html#a8705ab243733bb856d58534e0e853da3">service_queues</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643   <span class="keywordtype">int</span> changed;
<a name="l00644"></a>00644   <span class="keywordflow">do</span> {
<a name="l00645"></a>00645     changed  = <a class="code" href="network-mpi_8c.html#a3a991bb1d1d24fbb8695947451f3f765">test_q</a>(&amp;<a class="code" href="network-mpi_8c.html#a2401516883d34c1eb1a22de94da94724">posted_recvs</a>, me, <a class="code" href="network-mpi_8c.html#a149ffcda6e9840d885bfe970374a9f49">recv_finish</a>);
<a name="l00646"></a>00646     changed |= <a class="code" href="network-mpi_8c.html#a3a991bb1d1d24fbb8695947451f3f765">test_q</a>(&amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>, me, <a class="code" href="network-mpi_8c.html#a08594cce713aee586b50774147ce63df">send_finish</a>);
<a name="l00647"></a>00647     changed |= <a class="code" href="network-mpi_8c.html#a90b2df9e7fdef6bca9bd7e3f7ff6a294">recv_begin</a>(me);
<a name="l00648"></a>00648     changed |= <a class="code" href="network-mpi_8c.html#a4e1e1bd17bf05f66af5628d37dd9af9d">send_begin</a>(me);
<a name="l00649"></a>00649   } <span class="keywordflow">while</span> (changed);
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 <span class="comment">/*</span>
<a name="l00653"></a>00653 <span class="comment"> * NOTE: Chris believes that this network layer is too aggressive at</span>
<a name="l00654"></a>00654 <span class="comment"> * reading events out of the network.. so we are modifying the algorithm</span>
<a name="l00655"></a>00655 <span class="comment"> * to only send events when tw_net_send it called, and only read events</span>
<a name="l00656"></a>00656 <span class="comment"> * when tw_net_read is called.</span>
<a name="l00657"></a>00657 <span class="comment"> */</span>
<a name="l00658"></a>00658 <span class="keywordtype">void</span>
<a name="l00659"></a><a class="code" href="ross-network_8h.html#a29c8b71c5bbcfa0c7a30fc31769be05e">00659</a> <a class="code" href="network-mpi_8c.html#a27a1957e366f9b52848477702234fc08">tw_net_read</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *me)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661   <a class="code" href="network-mpi_8c.html#a8705ab243733bb856d58534e0e853da3">service_queues</a>(me);
<a name="l00662"></a>00662 }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="keywordtype">void</span>
<a name="l00665"></a><a class="code" href="ross-network_8h.html#a6392a492117a07ef4a834aff3e36ec33">00665</a> <a class="code" href="network-mpi_8c.html#ac1e0e20e3cba954c23932ed9a55d6dc6">tw_net_send</a>(<a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667   <a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> * me = e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a>-&gt;<a class="code" href="structtw__lp.html#a9fd32632e5c45a00faf16a6fd0814640">pe</a>;
<a name="l00668"></a>00668   <span class="keywordtype">int</span> changed = 0;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a5f5d71c18132da4f3412f48394413d92" title="Indicates union addr is in &#39;remote&#39; storage.">remote</a> = 0;
<a name="l00671"></a>00671   e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a> = <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021aa527853575c8e8e7c07398131ff2a047" title="Pending network transmission.">TW_net_outq</a>;
<a name="l00672"></a>00672   <a class="code" href="tw-eventq_8h.html#a6be6332230ef4fb5c8a3f4a0412493a8">tw_eventq_unshift</a>(&amp;outq, e);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="keywordflow">do</span>
<a name="l00675"></a>00675     {
<a name="l00676"></a>00676       changed = <a class="code" href="network-mpi_8c.html#a3a991bb1d1d24fbb8695947451f3f765">test_q</a>(&amp;<a class="code" href="network-mpi_8c.html#a890bf6aa5e4a2592e7980b7109ff94fc">posted_sends</a>, me, <a class="code" href="network-mpi_8c.html#a08594cce713aee586b50774147ce63df">send_finish</a>);
<a name="l00677"></a>00677       changed |= <a class="code" href="network-mpi_8c.html#a4e1e1bd17bf05f66af5628d37dd9af9d">send_begin</a>(me);
<a name="l00678"></a>00678     } <span class="keywordflow">while</span> (changed);
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="keywordtype">void</span>
<a name="l00682"></a><a class="code" href="ross-network_8h.html#a0f32f17f307a059cd2464da4039729fb">00682</a> <a class="code" href="network-mpi_8c.html#a7032d3d1b4b869e4f1669248c7cf6447">tw_net_cancel</a>(<a class="code" href="structtw__event.html" title="Event Stucture.">tw_event</a> *e)
<a name="l00683"></a>00683 {
<a name="l00684"></a>00684   <a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> *src_pe = e-&gt;<a class="code" href="structtw__event.html#ad82747d6237b1b03ef68c923bef423a0" title="Sending LP ID.">src_lp</a>-&gt;<a class="code" href="structtw__lp.html#a9fd32632e5c45a00faf16a6fd0814640">pe</a>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a>) {
<a name="l00687"></a>00687   <span class="keywordflow">case</span> <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021aa527853575c8e8e7c07398131ff2a047" title="Pending network transmission.">TW_net_outq</a>:
<a name="l00688"></a>00688     <span class="comment">/* Cancelled before we could transmit it.  Do not</span>
<a name="l00689"></a>00689 <span class="comment">     * transmit the event and instead just release the</span>
<a name="l00690"></a>00690 <span class="comment">     * buffer back into our own free list.</span>
<a name="l00691"></a>00691 <span class="comment">     */</span>
<a name="l00692"></a>00692     <a class="code" href="tw-eventq_8h.html#a5023008188f7e7e35ce1c77caeb0d17a">tw_eventq_delete_any</a>(&amp;outq, e);
<a name="l00693"></a>00693     <a class="code" href="ross-extern_8h.html#a5215643013906a13f0e2febadd0b0473">tw_event_free</a>(src_pe, e);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordflow">return</span>;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="keywordflow">break</span>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   <span class="keywordflow">case</span> <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a713a9666a4105fa38cb1545087a38b44" title="Network transmission in progress.">TW_net_asend</a>:
<a name="l00700"></a>00700     <span class="comment">/* Too late.  We&#39;ve already let MPI start to send</span>
<a name="l00701"></a>00701 <span class="comment">     * this event over the network.  We can&#39;t pull it</span>
<a name="l00702"></a>00702 <span class="comment">     * back now without sending another message to do</span>
<a name="l00703"></a>00703 <span class="comment">     * the cancel.</span>
<a name="l00704"></a>00704 <span class="comment">     *</span>
<a name="l00705"></a>00705 <span class="comment">     * Setting the cancel_q flag will signal us to do</span>
<a name="l00706"></a>00706 <span class="comment">     * another message send once the current send of</span>
<a name="l00707"></a>00707 <span class="comment">     * this message is completed.</span>
<a name="l00708"></a>00708 <span class="comment">     */</span>
<a name="l00709"></a>00709     e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#ac5983e758d7e1fd013dcda1ec5f848f1">cancel_asend</a> = 1;
<a name="l00710"></a>00710     <span class="keywordflow">break</span>;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712   <span class="keywordflow">case</span> <a class="code" href="ross-types_8h.html#adaaa11b02ebf87f0efe8abcee612b021a2aa790f48e8249fb18b1739b7cf9fef0" title="In tw_pe.sevent_q.">TW_pe_sevent_q</a>:
<a name="l00713"></a>00713     <span class="comment">/* Way late; the event was already sent and is in</span>
<a name="l00714"></a>00714 <span class="comment">     * our sent event queue.  Mark it as a cancel and</span>
<a name="l00715"></a>00715 <span class="comment">     * place it at the front of the outq.</span>
<a name="l00716"></a>00716 <span class="comment">     */</span>
<a name="l00717"></a>00717     e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#aff6407fbf10d86926eae51f389ae3cba" title="Actively on a dest_lp-&gt;pe&#39;s cancel_q.">cancel_q</a> = 1;
<a name="l00718"></a>00718     <a class="code" href="tw-eventq_8h.html#a6be6332230ef4fb5c8a3f4a0412493a8">tw_eventq_unshift</a>(&amp;outq, e);
<a name="l00719"></a>00719     <span class="keywordflow">break</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <span class="keywordflow">default</span>:
<a name="l00722"></a>00722     <span class="comment">/* Huh?  Where did you come from?  Why are we being</span>
<a name="l00723"></a>00723 <span class="comment">     * told about you?  We did not send you so we cannot</span>
<a name="l00724"></a>00724 <span class="comment">     * cancel you!</span>
<a name="l00725"></a>00725 <span class="comment">     */</span>
<a name="l00726"></a>00726     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(
<a name="l00727"></a>00727              <a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>,
<a name="l00728"></a>00728              <span class="stringliteral">&quot;Don&#39;t know how to cancel event owned by %u&quot;</span>,
<a name="l00729"></a>00729              e-&gt;<a class="code" href="structtw__event.html#aaccf9aa1154e261f109c6add9abb487b">state</a>.<a class="code" href="structtw__event.html#a6164e23fd9a6397de27abc5852f4b6c3" title="Owner of the next/prev pointers; see tw_event_owner.">owner</a>);
<a name="l00730"></a>00730   }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732   <a class="code" href="network-mpi_8c.html#a8705ab243733bb856d58534e0e853da3">service_queues</a>(src_pe);
<a name="l00733"></a>00733 }
<a name="l00734"></a>00734 <span class="comment"></span>
<a name="l00735"></a>00735 <span class="comment">/**</span>
<a name="l00736"></a>00736 <span class="comment"> * tw_net_statistics</span>
<a name="l00737"></a>00737 <span class="comment"> * @brief Function to output the statistics</span>
<a name="l00738"></a>00738 <span class="comment"> * @attention Notice that the MPI_Reduce &quot;count&quot; parameter is greater than one.</span>
<a name="l00739"></a>00739 <span class="comment"> * We are reducing on multiple variables *simultaneously* so if you change</span>
<a name="l00740"></a>00740 <span class="comment"> * this function or the struct tw_statistics, you must update the other.</span>
<a name="l00741"></a>00741 <span class="comment"> **/</span>
<a name="l00742"></a>00742 <a class="code" href="structtw__statistics.html" title="Statistics tallied over the duration of the simulation.">tw_statistics</a>   *
<a name="l00743"></a><a class="code" href="ross-network_8h.html#a37113c2afb3c223fcfb4a794df50c432">00743</a> <a class="code" href="network-mpi_8c.html#abbcd0d5ea79ad57229162f703309142d" title="Function to output the statistics.">tw_net_statistics</a>(<a class="code" href="structtw__pe.html" title="Holds the entire PE state.">tw_pe</a> * me, <a class="code" href="structtw__statistics.html" title="Statistics tallied over the duration of the simulation.">tw_statistics</a> * s)
<a name="l00744"></a>00744 {
<a name="l00745"></a>00745   <span class="keywordflow">if</span>(MPI_Reduce(&amp;(s-&gt;<a class="code" href="structtw__statistics.html#ab722d6c0f1d5a616b0b21789cbdecc16">s_max_run_time</a>), 
<a name="l00746"></a>00746                 &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#ab722d6c0f1d5a616b0b21789cbdecc16">s_max_run_time</a>,
<a name="l00747"></a>00747                 1,
<a name="l00748"></a>00748                 MPI_DOUBLE,
<a name="l00749"></a>00749                 MPI_MAX,
<a name="l00750"></a>00750                 (<span class="keywordtype">int</span>)<a class="code" href="ross-extern_8h.html#a5c6d576b06ba7fb5b28bc93c0b51f764">g_tw_masternode</a>,
<a name="l00751"></a>00751                 MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00752"></a>00752     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <span class="keywordflow">if</span>(MPI_Reduce(&amp;(s-&gt;<a class="code" href="structtw__statistics.html#a828101c0647ffa8c15ac324dba6b09d4">s_net_events</a>), 
<a name="l00755"></a>00755                 &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a828101c0647ffa8c15ac324dba6b09d4">s_net_events</a>,
<a name="l00756"></a>00756                 16,
<a name="l00757"></a>00757                 MPI_UNSIGNED_LONG_LONG,
<a name="l00758"></a>00758                 MPI_SUM,
<a name="l00759"></a>00759                 (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00760"></a>00760                 MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00761"></a>00761     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763   <span class="keywordflow">if</span>(MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#a77e96c47b9469e7a2dac21158f66d192">s_total</a>, 
<a name="l00764"></a>00764                 &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a77e96c47b9469e7a2dac21158f66d192">s_total</a>,
<a name="l00765"></a>00765                 8,
<a name="l00766"></a>00766                 MPI_UNSIGNED_LONG_LONG,
<a name="l00767"></a>00767                 MPI_MAX,
<a name="l00768"></a>00768                 (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00769"></a>00769                 MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00770"></a>00770     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00771"></a>00771     
<a name="l00772"></a>00772   <span class="keywordflow">if</span>(MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#a62e777ce390693fbe7b4fb88110c3c10">s_pe_event_ties</a>,
<a name="l00773"></a>00773         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a62e777ce390693fbe7b4fb88110c3c10">s_pe_event_ties</a>,
<a name="l00774"></a>00774         1,
<a name="l00775"></a>00775         MPI_UNSIGNED_LONG_LONG,
<a name="l00776"></a>00776         MPI_SUM,
<a name="l00777"></a>00777         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00778"></a>00778         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00779"></a>00779     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00780"></a>00780      
<a name="l00781"></a>00781   <span class="keywordflow">if</span>(MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#ae95e17e6072554ba17501ee43134f912">s_min_detected_offset</a>,
<a name="l00782"></a>00782         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#ae95e17e6072554ba17501ee43134f912">s_min_detected_offset</a>,
<a name="l00783"></a>00783         1,
<a name="l00784"></a>00784         MPI_DOUBLE,
<a name="l00785"></a>00785         MPI_MIN,
<a name="l00786"></a>00786         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00787"></a>00787         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00788"></a>00788     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00789"></a>00789     
<a name="l00790"></a>00790   <span class="keywordflow">if</span>(MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#a57f9136844021515905c3a6bc70eb921">s_avl</a>,
<a name="l00791"></a>00791         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a57f9136844021515905c3a6bc70eb921">s_avl</a>,
<a name="l00792"></a>00792         1,
<a name="l00793"></a>00793         MPI_UNSIGNED_LONG_LONG,
<a name="l00794"></a>00794         MPI_MAX,
<a name="l00795"></a>00795         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00796"></a>00796         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00797"></a>00797     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <span class="keywordflow">if</span> (MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#a11793b1e0f358ce83e0f0e7d858f14c5">s_buddy</a>,
<a name="l00800"></a>00800         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a11793b1e0f358ce83e0f0e7d858f14c5">s_buddy</a>,
<a name="l00801"></a>00801         1,
<a name="l00802"></a>00802         MPI_UNSIGNED_LONG_LONG,
<a name="l00803"></a>00803         MPI_MAX,
<a name="l00804"></a>00804         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00805"></a>00805         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00806"></a>00806     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="keywordflow">if</span> (MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#a43c6da6365aebc030d939dc378daf154">s_lz4</a>,
<a name="l00809"></a>00809         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#a43c6da6365aebc030d939dc378daf154">s_lz4</a>,
<a name="l00810"></a>00810         1,
<a name="l00811"></a>00811         MPI_UNSIGNED_LONG_LONG,
<a name="l00812"></a>00812         MPI_MAX,
<a name="l00813"></a>00813         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00814"></a>00814         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00815"></a>00815     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="keywordflow">if</span> (MPI_Reduce(&amp;s-&gt;<a class="code" href="structtw__statistics.html#abd593404137ee16d70a5c87547ad52d8">s_events_past_end</a>,
<a name="l00818"></a>00818         &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>.<a class="code" href="structtw__statistics.html#abd593404137ee16d70a5c87547ad52d8">s_events_past_end</a>,
<a name="l00819"></a>00819         1,
<a name="l00820"></a>00820         MPI_UNSIGNED_LONG_LONG,
<a name="l00821"></a>00821         MPI_SUM,
<a name="l00822"></a>00822         (<span class="keywordtype">int</span>)g_tw_masternode,
<a name="l00823"></a>00823         MPI_COMM_WORLD) != MPI_SUCCESS)
<a name="l00824"></a>00824     <a class="code" href="ross-extern_8h.html#a49ed2388aaae26e43280b7909c834aaa">tw_error</a>(<a class="code" href="ross-extern_8h.html#afffdf140f2c492f61546ad783833f127">TW_LOC</a>, <span class="stringliteral">&quot;Unable to reduce statistics!&quot;</span>);
<a name="l00825"></a>00825     
<a name="l00826"></a>00826   <span class="keywordflow">return</span> &amp;me-&gt;<a class="code" href="structtw__pe.html#ac1d26b7bfd058cc55cbf5ee201edb83c" title="per PE counters">stats</a>;
<a name="l00827"></a>00827 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Mon Jul 6 2015 18:25:40 for ROSS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
